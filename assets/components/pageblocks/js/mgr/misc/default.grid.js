PageBlocks.grid.Default=function(t){void 0!==(t=t||{}).multi_select&&1==t.multi_select&&(t.sm=new Ext.grid.CheckboxSelectionModel),t.proccessor=t.baseParams.action.split("/")[0]||"mgr",t.objectAction=t.baseParams.action.replace(/(\/\w+)$/,"").replace(/^(\w+\/)/,""),t.objectName=t.objectAction.split("/").join("-"),Ext.applyIf(t,{url:PageBlocks.config.connectorUrl,baseParams:{},autoHeight:!0,paging:!0,remoteSort:!0,stateful:!MODx.config.pageblocks_grid_stateful,stateId:t.id,ddGroup:t.id+"DD",enableDragDrop:!0,fields:this.getFields(t),columns:this.getColumns(t),tbar:this.getTopBar(t),listeners:this.getListeners(t),pageSize:20,viewConfig:{forceFit:!0,enableRowBody:!0,autoFill:!0,showPreview:!0,scrollOffset:-10,getRowClass:this.getRowClass}}),PageBlocks.grid.Default.superclass.constructor.call(this,t),this.store.on("load",function(){this._getSelectedIds().length&&this.getSelectionModel().clearSelections()},this),t.enableDragDrop&&t.ddAction&&this.on("render",function(e){e._initDD(t)})},Ext.extend(PageBlocks.grid.Default,MODx.grid.Grid,{getFields:function(){return["id","actions","published"]},getColumns:function(){return[{header:_("pb_grid_id"),dataIndex:"id",sortable:!0,width:75,fixed:!0},{header:_("pb_grid_actions"),dataIndex:"actions",renderer:PageBlocks.utils.renderActions,sortable:!1,width:165,fixed:!0,id:"actions",hidden:"2"!==PageBlocks.config.modxversion}]},createObject:function(e,t){var i=MODx.load({xtype:"pb-"+this.config.objectName+"-window-create",id:Ext.id(),listeners:{success:{fn:function(){this.refresh()},scope:this}}});i.reset(),i.setValues({published:!0}),i.show(t.target)},updateObject:function(e,i,t){if(void 0!==t)this.menu.record=t.data;else if(!this.menu.record)return!1;MODx.Ajax.request({url:this.config.url,params:{action:this.config.proccessor+"/"+this.config.objectAction+"/get",id:this.menu.record.id},listeners:{success:{fn:function(e){var t=MODx.load({xtype:"pb-"+this.config.objectName+"-window-update",id:Ext.id(),record:e.object,listeners:{success:{fn:function(){this.refresh()},scope:this}}});t.reset(),t.setValues(e.object),t.show(i.target)},scope:this}}})},removeObject:function(){var e=this._getSelectedIds();Ext.MessageBox.confirm(_("pb_row_remove_title"),1<e.length?_("pb_rows_remove_confirm"):_("pb_row_remove_confirm"),function(e){"yes"===e&&this.multipleAction(this.config.objectAction+"/remove")},this)},copyObject:function(){Ext.MessageBox.confirm(_("pb_row_copy"),_("pb_row_copy_confirm"),function(e){"yes"==e&&this.multipleAction(this.config.objectAction+"/copy")},this)},disableObject:function(){this.multipleAction(this.config.objectAction+"/disable")},enableObject:function(){this.multipleAction(this.config.objectAction+"/enable")},multipleAction:function(e){var t=this._getSelectedIds();if(!t.length)return!1;var i=this.getEl();i.mask(_("loading"),"x-mask-loading"),MODx.Ajax.request({url:PageBlocks.config.connectorUrl,params:{action:this.config.proccessor+"/multiple",method:e,ids:Ext.util.JSON.encode(t)},listeners:{success:{fn:function(){i.unmask(),this.refresh()},scope:this},failure:{fn:function(e){i.unmask(),MODx.msg.alert(_("error"),e.message)},scope:this}}})},getTopBar:function(){var e=[];return PageBlocks.grid.create&&e.push({text:'<i class="icon icon-plus"></i>&nbsp;'+_("pb_row_create"),handler:this.createObject,scope:this}),e.push("->",this.getSearchField()),e},getSearchField:function(e){return{xtype:"pb-field-search",width:e||250,listeners:{search:{fn:function(e){this._doSearch(e)},scope:this},clear:{fn:function(e){e.setValue(""),this._clearSearch()},scope:this}}}},getListeners:function(e){if(!e.readOnly)return{rowDblClick:function(e,t,i){t=e.store.getAt(t);this.updateObject(e,i,t)}}},getMenu:function(e,t){var i=this._getSelectedIds(),e=e.getStore().getAt(t),t=PageBlocks.utils.getMenu(e.data.actions,this,i);this.addContextMenuItem(t)},onClick:function(e){var t=e.getTarget();if("BUTTON"==t.nodeName){var i=this.getSelectionModel().getSelected();if(void 0!==i){var o,t=t.getAttribute("action");if("showMenu"==t)return o=this.getStore().find("id",i.id),this._showMenu(this,o,e);if("function"==typeof this[t])return this.menu.record=i.data,this[t](this,e)}}return this.processEvent("click",e)},getRowClass:function(e){var t=[];return e.data.published||void 0===e.data.published||t.push("pb-grid-row-disabled"),t.join(" ")},refresh:function(){this.getStore().reload(),1==this.config.enableDragDrop&&this.getSelectionModel().clearSelections(!0)},_doSearch:function(e){this.getStore().baseParams.query=e.getValue(),this.getBottomToolbar().changePage(1)},_clearSearch:function(){this.getStore().baseParams.query="",this.getBottomToolbar().changePage(1)},_getSelectedIds:function(){var e,t=[],i=this.getSelectionModel().getSelections();for(e in i)i.hasOwnProperty(e)&&t.push(i[e].id);return t},_initDD:function(c){var a,l;PageBlocks.grid.create&&(l=(a=this).getEl(),new Ext.dd.DropTarget(l,{ddGroup:a.ddGroup,notifyDrop:function(e,t,i){var o,s,n=a.getStore().getAt(e.getDragData(t).rowIndex),r=[];if(i.selections.length<1||i.selections[0].id==n.id)return!1;for(o in i.selections)i.selections.hasOwnProperty(o)&&(s=i.selections[o],r.push(s.id));l.mask(_("loading"),"x-mask-loading"),MODx.Ajax.request({url:c.url,params:{action:c.ddAction,sources:Ext.util.JSON.encode(r),target:n.id},listeners:{success:{fn:function(){l.unmask(),a.refresh(),"function"==typeof a.reloadTree&&(r.push(n.id),a.reloadTree(r))},scope:a},failure:{fn:function(){l.unmask()},scope:a}}})}}))},_loadStore:function(){this.store=new Ext.data.JsonStore({url:this.config.url,baseParams:this.config.baseParams||{action:this.config.action||"getList"},fields:this.config.fields,root:"results",totalProperty:"total",remoteSort:this.config.remoteSort||!1,storeId:this.config.storeId||Ext.id(),autoDestroy:!0,listeners:{load:function(e,t,i){e.sortInfo={field:i.params.sort||"id",direction:i.params.dir||"ASC"},Ext.getCmp("modx-content").doLayout()}}})}}),Ext.reg("pb-grid-default",PageBlocks.grid.Default);