PageBlocks.utils.getMenu=function(e,t,i){var a,l,s,o,n,r=[],c=!1;for(n in e)if(e.hasOwnProperty(n)){var u=e[n];if(!PageBlocks.grid.create){if("copyObject"==u.action)continue;if("disableObject"==u.action)continue;if("enableObject"==u.action)continue;if("removeObject"==u.action&&u.remove)continue}if(u.menu){if(0<r.length&&!c&&(/^remove/i.test(u.action)||/^delete/i.test(u.action))&&(r.push("-"),c=!0),1<i.length){if(!u.multiple)continue;"string"==typeof u.multiple&&(u.title=u.multiple)}l=u.icon||"","object"==typeof u.cls?void 0!==u.cls.menu&&(l+=" "+u.cls.menu):a=u.cls||"",s=u.title||u.title,o=u.action?t[u.action]:"",r.push({handler:o,text:String.format('<span class="{0}"><i class="x-menu-item-icon {1}"></i>{2}</span>',a,l,s),scope:t})}else"-"==u&&r.push("-")}return r},PageBlocks.utils.renderBoolean=function(e){return e?String.format('<span class="green">{0}</span>',_("yes")):String.format('<span class="red">{0}</span>',_("no"))},PageBlocks.utils.renderButton=function(e){return e.caption},PageBlocks.utils.previewImage=function(e){return Ext.isEmpty(e)?"":((e=/\/\//.test(e)||/^\//.test(e)?e:"/"+e).indexOf(".svg")||(e=MODx.config.connectors_url+"system/phpthumb.php?h=100&f=png&src="+e+"&source=1"),String.format('<img src="{0}" style="max-width:100%;height:100px;margin:10px auto"/>',e))},PageBlocks.utils.renderImage=function(e){return Ext.isEmpty(e)?"":((e=/\/\//.test(e)||/^\//.test(e)?e:"/"+e).indexOf(".svg")||(e=MODx.config.connectors_url+"system/phpthumb.php?h=100&f=png&src="+e+"&source=1"),String.format('<img src="{0}" style="max-width:100%;height:auto;max-height:100px;margin:0"/>',e))},PageBlocks.utils.renderVideo=function(e,t,i){return Ext.isEmpty(e)?"":(/\/\//.test(e)||/^\//.test(e)||(e="/"+e),"video"==i?String.format('<video width="360" height="200" controls style="max-width:100%;margin:10px auto"><source src="{0}" type="video/mp4"></video>',e):String.format('<h3 style="margin:10px 0">{0}</h3><iframe width="360" height="200" style="max-width:100%;margin:10px auto" src="{1}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>',t,e))},PageBlocks.utils.renderDate=function(e){return Ext.isEmpty(e)?"â€”":e},PageBlocks.utils.renderActions=function(e,t,i){var a,l,s,o,n=[];for(o in i.data.actions)if(i.data.actions.hasOwnProperty(o)){var r=i.data.actions[o];if(r.button){if(!PageBlocks.grid.create){if("copyObject"==r.action)continue;if("disableObject"==r.action)continue;if("enableObject"==r.action)continue;if("removeObject"==r.action&&r.remove)continue}s=r.icon||"","object"==typeof r.cls?void 0!==r.cls.button&&(s+=" "+r.cls.button):a=r.cls||"",l=r.action||"",r=r.title||"",s=String.format('<li class="{0}"><button class="pb-btn pb-btn-default {1}" action="{2}" title="{3}"></button></li>',a,s,l,r),n.push(s)}}return String.format('<ul class="pb-row-actions">{0}</ul>',n.join(""))},PageBlocks.utils.setDefaultValue=function(e,t){setTimeout(()=>{if(!Ext.isEmpty(t)&&!e.getValue()&&"function"==typeof e.setValue){switch(e.xtype){case"pb-combo-listbox-multiple":t=t.split("||");break;case"xcheckbox":t=+t}e.setValue(t)}},0)},PageBlocks.utils.renderRTE=function(e){e&&MODx.loadRTE&&MODx.loadRTE(e.id)},PageBlocks.utils.getXtype=function(l,e){let i=e&&e[l.name]?e[l.name]:"",a={xtype:l.type,fieldLabel:l.caption,name:l.name,id:"record-"+e.extid+"-"+l.name,cls:"field-"+l.type,anchor:"99.5%",width:"100%",allowBlank:!l.required,description:"<b>[[*"+l.name+"]]</b>",readOnly:l.readonly||0,record:i,listeners:{afterrender:function(e){PageBlocks.utils.setDefaultValue(e,l.default)}}};var t="3"===PageBlocks.config.modxversion?MODx.config:MODx.clientconfig;switch(l.source&&(l.media_source=PageBlocks.config.media_source[l.source]),l.source_path&&(s=e&&e.id?e.id:"temp"+l.id,l.openTo=l.media_source?l.media_source.baseUrl:"/",l.source_path=l.source_path.replace("[[+resource_id]]",PageBlocks.resource.id),l.source_path=l.source_path.replace("[[+id]]",s)),l.type){case"richtext":a.xtype="textarea",a.listeners.afterrender=function(e){PageBlocks.utils.setDefaultValue(e,l.default),PageBlocks.utils.renderRTE(e)};break;case"modx-texteditor":a.height=200,a.mimeType="text/x-smarty",a.modxTags=!0,a.listeners={render:function(e){"undefined"==e.getValue()&&e.setValue("")}};break;case"listbox":a.xtype="pb-combo-listbox",Ext.isEmpty(l.values)?(a.xtype="pb-combo-getlist",a.url=l.connector,a.displayField=l.displayfield,a.pageSize=l.limit,a.baseParams={action:l.processor,where:l.where,sort:l.sort,dir:l.dir,limit:0,displayfield:l.displayfield,combo:1}):(0===l.values.indexOf("++")&&(l.values=t[l.values.replace("++","")]),a.data=l.values);break;case"listbox-multiple":a.xtype="pb-combo-listbox-multiple",Ext.isEmpty(l.values)?(a.xtype="pb-combo-getlist-multiple",a.url=l.connector,a.displayField=l.displayfield,a.pageSize=l.limit,a.baseParams={action:l.processor,where:l.where,sort:l.sort,dir:l.dir,limit:0,displayfield:l.displayfield,combo:1}):(0===l.values.indexOf("++")&&(l.values=t[l.values.replace("++","")]),a.data=l.values),a.listeners={afterrender:function(e){setTimeout(()=>{Ext.isEmpty(i)||e.setValue(i)},500)}};break;case"resourcelist":a.xtype="pb-combo-resource",a.baseParams={action:"web/combo/resourcelist",where:l.where,sort:l.sort,dir:l.dir,limit:10,combo:1};break;case"combo-boolean":a.hiddenName=l.name,a.store=new Ext.data.SimpleStore({fields:["d","v"],data:[[_("yes"),1],[_("no"),0]]}),a.listeners.afterrender=function(e){PageBlocks.utils.setDefaultValue(e,l.default),Ext.isEmpty(i)||setTimeout(()=>{e.hiddenField.value=+i},100)};break;case"numberfield":a.inputType="number",a.cls="x-form-text",l.number_allownegative||(a.minValue=0),Ext.isEmpty(l.number_minvalue)||(a.minValue=l.number_minvalue),Ext.isEmpty(l.number_maxvalue)||(a.maxValue=l.number_maxvalue);break;case"xcheckbox":a.hideLabel=!0,a.boxLabel=l.caption,a.inputValue=+l.default||0,a.checked=+i,a.listeners={afterrender:function(e){i?e.setValue(+i):PageBlocks.utils.setDefaultValue(e,l.default)}};break;case"checkboxgroup":a.columns=+l.columns||1,a.items=[],a.name="",0===l.values.indexOf("++")&&(l.values=t[l.values.replace("++","")]),l.values.split("||").forEach(function(e){var t=(e=e.split("=="))[0],e=e[1]||e[0];a.items.push({xtype:"checkbox",boxLabel:t,inputValue:e,name:l.name+"[]",id:Ext.id(),checked:i?i.includes(e):l.default==e})});break;case"radiogroup":a.columns=+l.columns||1,a.items=[],a.name="",a.listeners={},0===l.values.indexOf("++")&&(l.values=t[l.values.replace("++","")]),l.values.split("||").forEach(function(e){e=e.split("==");a.items.push({boxLabel:e[0],inputValue:e[1]||e[0],name:l.name,id:Ext.id(),checked:i?i.includes(e[1]||e[0]):l.default==(e[1]||e[0]),listeners:{render:function(e){!Ext.isEmpty(l.default)&&Ext.isEmpty(e.inputValue)&&e.setValue(l.default)}}})});break;case"pb-panel-file":a.source=l.source,a.source_path=l.source_path||"/",a.allowedFileTypes=l.media_source.allowedFileTypes,a.openTo=l.openTo||"/",a.panel_help=l.help,l.help="";break;case"pb-panel-image":case"pb-panel-video":a.model_id=l.model_id||0,a.source=l.source,a.source_path=l.source_path||"/",a.allowedFileTypes=l.media_source.allowedFileTypes,a.openTo=l.openTo||"/",a.panel_help=l.help,l.help="",a.listeners={afterrender:function(a){setTimeout(function(){let i=document.getElementById(a.id+"-input");if(Ext.isEmpty(i.value)&&!Ext.isEmpty(l.default)){let t=new Image;t.src=MODx.config.base_url+l.default,t.onload=function(){i.value=l.default;var e=document.getElementById(a.id+"-info"),e=(e&&(e.value=JSON.stringify({url:l.default,width:t.width,height:t.height,title:l.default.split("/").pop()})),Ext.getCmp(a.id+"-preview"));e&&e.update(PageBlocks.utils.previewImage(l.default))}}},500)}};break;case"pb-panel-button":a.listeners={afterrender:function(t){setTimeout(function(){var e=document.getElementById(t.xtype_id);Ext.isEmpty(e.value)&&!Ext.isEmpty(l.default)&&(e.value=JSON.stringify({caption:l.default}),e=document.querySelector("#"+t.xtype_id+"-panel button"))&&(e.innerText=l.default)},500)}};break;case"xdatetime":a.dateFormat=MODx.config.manager_date_format,a.timeFormat=MODx.config.manager_time_format,a.startDay=parseInt(MODx.config.manager_week_start),a.dateWidth=l.hide_time?"100%":"70%",a.timeWidth=l.hide_time?0:"30%",a.hideTime=+l.hide_time,a.timeIncrement=+l.time_increment||15,a.minTimeValue=l.time_minvalue||void 0,a.maxTimeValue=l.time_maxvalue||void 0,l.disabled_dates&&(a.disabledDates=l.disabled_dates.split(",")),l.disabled_days&&(a.disabledDays=l.disabled_days.split(","));break;case"timefield":a.xtype="timefield",a.format=MODx.config.manager_time_format,a.increment=+l.time_increment||15,a.minValue=l.time_minvalue||void 0,a.maxValue=l.time_maxvalue||void 0;break;case"pb-table":a.record=e,a.model_type=l.model_type,a.model_id=e?e.id:0,a.constructor_id=l.table_id,a.field_id=l.id,a.table_columns=l.table_columns,a.panel_help=l.help,delete a.listeners;break;case"colorpalette":l.readonly?a.tpl=new Ext.XTemplate('<tpl for="."><label class="color-item"><input type="checkbox" disabled name="'+l.name+'[]" value="{.}" style="background-color:#{.}"/></label></tpl>'):a.tpl=new Ext.XTemplate('<tpl for="."><label class="color-item"><input type="checkbox" name="'+l.name+'[]" value="{.}" style="background-color:#{.}"/></label></tpl>'),delete a.anchor,a.listeners={},a.values=i,a.listeners.afterRender=function(e){PageBlocks.utils.setDefaultValue(e,l.default),Ext.ColorPalette.superclass.afterRender.call(this),i.length&&i.forEach(e=>{e=this.el.child('.color-item input[value="'+e+'"]');e&&(e.dom.checked=!0)})},l.values&&(a.colors=l.values.split("||"),a.colors.forEach((e,t)=>{e=(e=e.split("=="))[1]||e[0],a.colors[t]=e.replace("#","")}));break;case"colorpicker":a.xtype="textfield",a.cls="coloris",a.anchor="20%",a.listeners={change:{fn:MODx.fireResourceFormChange,scope:this},afterrender:function(e){PageBlocks.utils.setDefaultValue(e,l.default),Coloris({el:".coloris",wrap:!0,theme:"modx"+ColorPicker.config.modxversion,themeMode:"light",margin:5,format:"hex",formatToggle:!0,alpha:!0,swatchesOnly:!1,focusInput:!1,autoClose:!0,clearButton:{show:!0,label:_("delete")},swatches:[]}),setTimeout(()=>{e.container.dom.querySelector(".clr-field").style.color=e.value},500)}};break;case"readonly":a.xtype="textfield",a.readOnly=!0;break;case"pb-xtype":a.xtype=l.xtype,a.hiddenName=l.name,"modx-description"==l.xtype&&(a.listeners={},a.html=l.default)}var s=[a],o=(Ext.isEmpty(l.help)||s.push({xtype:"label",id:Ext.id(),cls:"desc-under",text:l.help}),[l.cls]);return 1==l.hide_time&&o.push("pb-hidden-time"),a={layout:"form",defaults:{msgTarget:"under"},columnWidth:1,labelAlign:"top",width:"100%",items:s,cls:o.join(" ")},a="3"===PageBlocks.config.modxversion?{layout:"form",width:"100%",cls:"x-panel modx3-resource-panel x-form-label-top",items:[a]}:a},PageBlocks.utils.buildFields=function(e,s){(s=s||{}).extid=Ext.id();let i=[],t=[],o=[],a=!1,l=100;return e.filter(e=>0!==e.tab_id).forEach(e=>{t[e.tab_rank]=e.tab_name}),e.filter(e=>0===e.tab_id).forEach(e=>{var t=PageBlocks.utils.getXtype(e,s);100==e.width?(i.push(t),a=!1):((l-=e.width)<0&&(a=!1,l=100-e.width),a||(i.push({layout:"column",items:[]}),a=!0),l<0?a=!0:i[i.length-1].items.push({columnWidth:e.width/100,layout:"form",width:"100%",defaults:{msgTarget:"under"},items:[t]}))}),t.length&&(t.forEach(t=>{let i=!1,a=[],l=100;e.filter(e=>e.tab_name===t).forEach(e=>{var t=PageBlocks.utils.getXtype(e,s);100==e.width?(a.push(t),i=!1):((l-=e.width)<0&&(i=!1,l=100-e.width),i||(a.push({layout:"column",items:[]}),i=!0),l<0?i=!0:a[a.length-1].items.push({columnWidth:e.width/100,layout:"form",width:"100%",defaults:{msgTarget:"under"},items:[t]}))}),o.push({title:t,layout:"anchor",items:a,hideMode:"offsets",defaults:{msgTarget:"under",border:!1}})}),i.push({xtype:"modx-tabs",deferredRender:!1,stateful:!0,id:Ext.id(),items:o})),i},PageBlocks.utils.request=function(e,t,i){MODx.Ajax.request({url:PageBlocks.config.connectorUrl,params:e,listeners:{success:{fn:function(e){"function"==typeof t&&t(e)},scope:this},failure:{fn:function(e){"function"==typeof i&&i(e)},scope:this}}})};