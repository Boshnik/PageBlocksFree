PageBlocks.panel.SuperImage=function(e){(e=e||{}).imgId=e.id||Ext.id(),Ext.isEmpty(e.source)&&(e.source=MODx.config.default_media_source),Ext.isEmpty(e.openTo)&&(e.openTo=MODx.config.pageblocks_source_path),Ext.apply(e,{baseCls:"pb-panel-image",id:e.imgId,layout:"anchor",hideMode:"offsets",items:this.getFields(e)}),PageBlocks.panel.SuperImage.superclass.constructor.call(this,e)},Ext.extend(PageBlocks.panel.SuperImage,MODx.Panel,{getFields:function(e){return[{xtype:"modx-combo-browser",name:e.name,description:"<b>[[*"+e.name+"]]</b>",id:e.imgId+"-input",multiple:!1,allowBlank:e.allowBlank,msgTarget:"title",source:e.source,hideSourceCombo:!1,hideFiles:e.hideFiles||!1,allowedFileTypes:e.allowedFileTypes||"",openTo:e.source_path||"/",rootId:"/",rootVisible:!0,triggerConfig:{tag:"div",cls:"pb-combo-btns",cn:[{tag:"div",cls:"x-form-trigger icon icon-close",trigger:"clear"},{tag:"div",cls:"x-form-trigger x-field-combo-list icon icon-image",trigger:"file"}]},onTriggerClick:function(e,i){"clear"===i.getAttribute("trigger")?(this.setValue(""),this.fireEvent("change",this)):this.__proto__.onTriggerClick.call(this)},listeners:{afterrender:e=>{setTimeout(()=>{Ext.isEmpty(e.value)||(this.getCmp("input").setValue(e.value),this.updatePreview(e.value))},500)},select:e=>{this.getCmp("input").setValue(e.fullRelativeUrl||e.url),this.updatePreview(e.fullRelativeUrl||e.url)},change:e=>{this.getCmp("input").setValue(e.value),this.updatePreview(e.getValue())}}},{xtype:"label",cls:"desc-under",text:e.panel_help,hidden:Ext.isEmpty(e.panel_help)?1:0},{anchor:"100%",html:"",bodyCssClass:"",id:e.imgId+"-preview"}]},getCmp:function(e){return Ext.getCmp(this.imgId+"-"+e)},updatePreview:function(e){this.getCmp("preview").update(PageBlocks.utils.previewImage(e))}}),Ext.reg("pb-image",PageBlocks.panel.SuperImage),PageBlocks.panel.SuperImageInfo=function(e){(e=e||{}).imgId=e.id||Ext.id(),Ext.isEmpty(e.source)&&(e.source=MODx.config.default_media_source),Ext.isEmpty(e.openTo)&&(e.openTo=MODx.config.pageblocks_source_path),Ext.apply(e,{baseCls:"pb-panel-image",id:e.imgId,layout:"anchor",hideMode:"offsets",items:this.getFields(e)}),PageBlocks.panel.SuperImageInfo.superclass.constructor.call(this,e),Ext.onReady(()=>this.loadFileForm())},Ext.extend(PageBlocks.panel.SuperImageInfo,PageBlocks.panel.SuperImage,{storage:{},getFields:function(t){return[{xtype:"modx-combo-browser",name:t.name+"-url",description:"<b>[[*"+t.name+"]]</b>",id:t.imgId+"-input",multiple:!1,allowBlank:t.allowBlank,msgTarget:"title",source:t.source,hideSourceCombo:!1,hideFiles:t.hideFiles||!1,allowedFileTypes:t.allowedFileTypes||"",openTo:t.source_path||"/",rootId:"/",rootVisible:!0,readOnly:t.readOnly,triggerConfig:t.readOnly?{}:{tag:"div",cls:"pb-combo-btns",cn:[{tag:"div",cls:"x-form-trigger icon icon-close",trigger:"clear"},{tag:"div",cls:"x-form-trigger x-field-combo-list icon icon-image",trigger:"file"},{tag:"div",cls:"x-form-trigger icon icon-desktop",trigger:"desktop"},{tag:"div",cls:"x-form-trigger icon icon-info",trigger:"info"}]},onTriggerClick:function(e,i){switch(i.getAttribute("trigger")){case"clear":this.setValue(""),this.fireEvent("change",this);break;case"desktop":Ext.getCmp(t.imgId+"-file").el.dom.nextSibling.click();break;case"info":this.fireEvent("info",this);break;default:this.__proto__.onTriggerClick.call(this)}},listeners:{afterrender:e=>{setTimeout(()=>{Ext.isEmpty(t.record)||(this.getCmp("input").setValue(t.record.url),this.getCmp("info").setValue(JSON.stringify(t.record)),this.updatePreview(t.record.url))},500)},select:e=>{this.getCmp("input").setValue(e.fullRelativeUrl||e.url),this.updatePreview(e.fullRelativeUrl||e.url),Ext.isObject(this.record)||(this.record={}),this.record.url=e.fullRelativeUrl||e.url,this.record.width=e.image_width,this.record.height=e.image_height,this.record.size=e.size,this.record.title=e.name,this.updateInfo(this.record)},change:e=>{this.getCmp("input").setValue(e.getValue()),this.updatePreview(e.getValue());var i=this.getCmp("info").getValue();(i=Ext.isEmpty(i)?{}:JSON.parse(i)).url=e.getValue(),this.getCmp("info").setValue(JSON.stringify(i))},info:e=>{Ext.isEmpty(e.getValue())?MODx.msg.alert(_("error"),_("pb_img_empty")):this.infoWindow()}}},{xtype:"label",cls:"desc-under",text:t.panel_help,hidden:Ext.isEmpty(t.panel_help)?1:0},{anchor:"100%",html:"",bodyCssClass:"",id:t.imgId+"-preview"},{xtype:"hidden",id:t.imgId+"-info",name:t.name}]},updateInfo:function(e){this.getCmp("info").setValue(Ext.isEmpty(e)?"":JSON.stringify(e))},infoWindow:function(){var e=this.getCmp("info").getValue(),e=Ext.isEmpty(e)?"":JSON.parse(e),i=MODx.load({xtype:"pb-image-info",record:e,imgId:this.imgId});i.reset(),Ext.isEmpty(e)||i.setValues(e),i.show()},loadFileForm:function(){this.fileform=new PageBlocks.fileformImage({id:this.imgId+"-fileform",renderTo:Ext.getBody(),imgId:this.imgId,source:this.source,source_path:this.source_path,pbImage:this})}}),Ext.reg("pb-panel-image",PageBlocks.panel.SuperImageInfo),PageBlocks.window.SuperImageInfoWindow=function(e){(e=e||{}).id||(e.id=Ext.id()),Ext.applyIf(e,{title:"Info",width:500}),PageBlocks.window.SuperImageInfoWindow.superclass.constructor.call(this,e)},Ext.extend(PageBlocks.window.SuperImageInfoWindow,PageBlocks.window.Default,{getFields:function(e){return[{layout:"column",items:[{columnWidth:.5,layout:"form",defaults:{msgTarget:"under"},items:[{xtype:"numberfield",inputType:"number",minValue:0,cls:"x-form-text",fieldLabel:_("pb_img_width"),name:"width",id:e.id+"-width",anchor:"100%",allowBlank:!0}]},{columnWidth:.5,layout:"form",defaults:{msgTarget:"under"},items:[{xtype:"numberfield",inputType:"number",minValue:0,cls:"x-form-text",fieldLabel:_("pb_img_height"),name:"height",id:e.id+"-height",anchor:"100%",allowBlank:!0}]}]},{xtype:"textfield",fieldLabel:_("pb_img_title"),name:"title",id:e.id+"-title",anchor:"100%",allowBlank:!0}]},submit:function(){var e=this.fp.getForm();e.isValid()&&(e=Object.assign(this.record,e.getValues()),Ext.getCmp(this.imgId+"-info").setValue(JSON.stringify(e)),this.close(),this.doLayout())}}),Ext.reg("pb-image-info",PageBlocks.window.SuperImageInfoWindow),PageBlocks.fileformImage=function(e){e=e||{},Ext.applyIf(e,{isUpload:!0,hidden:!0,fileUpload:!0,url:PageBlocks.config.connectorUrl,baseParams:{action:"web/browser/file/upload",source:e.source,source_path:e.source_path,idFile:e.imgId+"-file"},items:[{xtype:"fileuploadfield",id:e.imgId+"-file",source:e.source||MODx.config.default_media_source,allowedFileTypes:"png",listeners:{fileselected:(e,i)=>{this.onFileSelected(e,i)}}}]}),PageBlocks.fileformImage.superclass.constructor.call(this,e)},Ext.extend(PageBlocks.fileformImage,Ext.FormPanel,{onFileSelected:function(e,i){this.form.baseParams.file=i,this.form.submit({waitMsg:"Uploading...",params:{},success:function(e,i){i=i.result.object;this.pbImage.getCmp("input").setValue(i.url),this.pbImage.updatePreview(i.url),this.pbImage.getCmp("info").setValue(JSON.stringify(i))},failure:function(e,i){MODx.msg.alert("Error",i.result.message)},scope:this})}}),Ext.reg("pageblocks-fileform-image",PageBlocks.fileformImage);