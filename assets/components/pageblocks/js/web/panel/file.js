PageBlocks.panel.SuperFile=function(e){(e=e||{}).elID=e.id||Ext.id(),Ext.isEmpty(e.source)&&(e.source=MODx.config.default_media_source),Ext.isEmpty(e.openTo)&&(e.openTo=MODx.config.pageblocks_source_path),Ext.apply(e,{baseCls:"pb-panel-file",id:e.elID,layout:"anchor",hideMode:"offsets",items:this.getFields(e)}),PageBlocks.panel.SuperFile.superclass.constructor.call(this,e),Ext.onReady(()=>this.loadFileForm())},Ext.extend(PageBlocks.panel.SuperFile,MODx.Panel,{getFields:function(i){return[{xtype:"modx-combo-browser",name:i.name,description:"<b>[[*"+i.name+"]]</b>",id:i.elID+"-input",multiple:!1,allowBlank:i.allowBlank,msgTarget:"title",source:i.source,hideSourceCombo:!1,hideFiles:i.hideFiles||!1,allowedFileTypes:i.allowedFileTypes||"",openTo:i.source_path||"/",rootId:"/",rootVisible:!0,triggerConfig:{tag:"div",cls:"pb-combo-btns",cn:[{tag:"div",cls:"x-form-trigger icon icon-close",trigger:"clear"},{tag:"div",cls:"x-form-trigger x-form-file-trigger",trigger:"file"},{tag:"div",cls:"x-form-trigger icon icon-desktop",trigger:"desktop"}]},onTriggerClick:function(e,l){switch(l.getAttribute("trigger")){case"clear":this.setValue(""),this.fireEvent("change",this);break;case"desktop":Ext.getCmp(i.elID+"-file").el.dom.nextSibling.click();break;default:this.__proto__.onTriggerClick.call(this)}},listeners:{afterrender:e=>{setTimeout(()=>{Ext.isEmpty(e.value)||this.getCmp("input").setValue(e.value)},500)},select:e=>{this.getCmp("input").setValue(e.fullRelativeUrl||e.url)},change:e=>{this.getCmp("input").setValue(e.value)}}},{xtype:"label",cls:"desc-under",text:i.panel_help,hidden:Ext.isEmpty(i.panel_help)?1:0}]},getCmp:function(e){return Ext.getCmp(this.elID+"-"+e)},loadFileForm:function(){this.fileform=new PageBlocks.fileformFile({id:this.elID+"-fileform",renderTo:Ext.getBody(),elID:this.elID,source:this.source,source_path:this.source_path,pbFile:this})}}),Ext.reg("pb-panel-file",PageBlocks.panel.SuperFile),PageBlocks.fileformFile=function(e){e=e||{},Ext.applyIf(e,{isUpload:!0,hidden:!0,fileUpload:!0,url:PageBlocks.config.connectorUrl,baseParams:{action:"web/browser/file/upload",source:e.source,source_path:e.source_path,idFile:e.elID+"-file"},items:[{xtype:"fileuploadfield",id:e.elID+"-file",source:e.source||MODx.config.default_media_source,allowedFileTypes:"png",listeners:{fileselected:(e,l)=>{this.onFileSelected(e,l)}}}]}),PageBlocks.fileformFile.superclass.constructor.call(this,e)},Ext.extend(PageBlocks.fileformFile,Ext.FormPanel,{onFileSelected:function(e,l){this.form.baseParams.file=l,this.form.submit({waitMsg:"Uploading...",params:{},success:function(e,l){l=l.result.object;this.pbFile.getCmp("input").setValue(l.url)},failure:function(e,l){MODx.msg.alert("Error",l.result.message)},scope:this})}}),Ext.reg("pageblocks-fileform-file",PageBlocks.fileformFile);