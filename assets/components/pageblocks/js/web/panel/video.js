PageBlocks.panel.SuperVideo=function(e){(e=e||{}).videoId=e.id||Ext.id(),Ext.isEmpty(e.source)&&(e.source=MODx.config.default_media_source),Ext.isEmpty(e.openTo)&&(e.openTo=MODx.config.pageblocks_source_path),Ext.apply(e,{baseCls:"pb-panel-video",id:e.videoId,layout:"anchor",hideMode:"offsets",items:this.getFields(e)}),PageBlocks.panel.SuperVideo.superclass.constructor.call(this,e)},Ext.extend(PageBlocks.panel.SuperVideo,MODx.Panel,{storage:{},getFields:function(i){return[{xtype:"modx-combo-browser",name:i.name,description:"<b>[[*"+i.name+"]]</b>",id:i.videoId+"-input",multiple:!1,allowBlank:i.allowBlank,msgTarget:"title",source:i.source,hideSourceCombo:!1,hideFiles:i.hideFiles||!1,allowedFileTypes:i.allowedFileTypes||"",openTo:i.source_path||"/",rootId:"/",rootVisible:!0,triggerConfig:{tag:"div",cls:"pb-combo-btns",cn:[{tag:"div",cls:"x-form-trigger icon icon-close",trigger:"clear"},{tag:"div",cls:"x-form-trigger x-field-combo-list icon icon-image"}]},onTriggerClick:function(e,i){"clear"===i.getAttribute("trigger")?(this.setValue(""),this.fireEvent("change",this)):this.__proto__.onTriggerClick.call(this)},listeners:{afterrender:e=>{setTimeout(()=>{Ext.isEmpty(i.value)||this.updatePreview({provider:"video",embed_video:i.value,title:""})},500)},select:e=>{this.getCmp("input").setValue(e.fullRelativeUrl||e.url),this.updatePreview({provider:"video",embed_video:e.fullRelativeUrl||e.url})},change:e=>{Ext.isEmpty(e.getValue())&&this.updatePreview("")},info:e=>{Ext.isEmpty(e.getValue())?MODx.msg.alert(_("error"),_("pb_video_url_invalid")):this.infoWindow()}}},{xtype:"label",cls:"desc-under",text:i.panel_help,hidden:Ext.isEmpty(i.panel_help)?1:0},{anchor:"100%",html:"",bodyCssClass:"",id:i.videoId+"-preview"}]},getCmp:function(e){return Ext.getCmp(this.videoId+"-"+e)},updatePreview:function(e){this.getCmp("preview").update(PageBlocks.utils.renderVideo(e.embed_video,e.title,e.provider))}}),Ext.reg("pb-video",PageBlocks.panel.SuperVideo),PageBlocks.panel.SuperVideoInfo=function(e){(e=e||{}).videoId=e.id||Ext.id(),Ext.isEmpty(e.source)&&(e.source=MODx.config.default_media_source),Ext.isEmpty(e.openTo)&&(e.openTo=MODx.config.pageblocks_source_path),Ext.apply(e,{baseCls:"pb-panel-video",id:e.videoId,layout:"anchor",hideMode:"offsets",items:this.getFields(e)}),PageBlocks.panel.SuperVideoInfo.superclass.constructor.call(this,e),Ext.onReady(()=>this.loadFileForm())},Ext.extend(PageBlocks.panel.SuperVideoInfo,MODx.Panel,{storage:{},getFields:function(t){return[{xtype:"modx-combo-browser",name:t.name+"-url",description:"<b>[[*"+t.name+"]]</b>",id:t.videoId+"-input",multiple:!1,allowBlank:t.allowBlank,msgTarget:"title",source:t.source,hideSourceCombo:!1,hideFiles:t.hideFiles||!1,allowedFileTypes:t.allowedFileTypes||"",openTo:t.source_path||"/",rootId:"/",rootVisible:!0,triggerConfig:{tag:"div",cls:"pb-combo-btns",cn:[{tag:"div",cls:"x-form-trigger icon icon-close",trigger:"clear"},{tag:"div",cls:"x-form-trigger x-field-combo-list icon icon-image"},{tag:"div",cls:"x-form-trigger icon icon-desktop",trigger:"desktop"},{tag:"div",cls:"x-form-trigger icon icon-info",trigger:"info"}]},onTriggerClick:function(e,i){switch(i.getAttribute("trigger")){case"clear":this.setValue(""),this.fireEvent("change",this);break;case"desktop":Ext.getCmp(t.videoId+"-file").el.dom.nextSibling.click();break;case"info":this.fireEvent("info",this);break;default:this.__proto__.onTriggerClick.call(this)}},listeners:{afterrender:e=>{setTimeout(()=>{Ext.isEmpty(t.record)||(this.getCmp("input").setValue(t.record.url),this.getCmp("info").setValue(JSON.stringify(t.record)),this.updatePreview({provider:"video",embed_video:t.record.url,title:t.record.name}))},500)},select:e=>{this.getCmp("input").setValue(e.fullRelativeUrl||e.url),this.updatePreview({provider:"video",embed_video:e.fullRelativeUrl||e.url}),Ext.isObject(this.record)||(this.record={}),this.record.url=e.fullRelativeUrl||e.url,this.record.title=e.name,this.updateInfo(this.record)},change:e=>{let i=this.getCmp("info").getValue();e=e.getValue();Ext.isEmpty(e)?(this.updatePreview(""),this.updateInfo("")):this.getInfo(e,e=>{Ext.isEmpty(e.embed_video)||(this.updatePreview(e),Ext.isEmpty(i)&&this.updateInfo(e))})},info:e=>{Ext.isEmpty(e.getValue())?MODx.msg.alert(_("error"),_("pb_video_url_invalid")):this.infoWindow()}}},{xtype:"label",cls:"desc-under",text:t.panel_help,hidden:Ext.isEmpty(t.panel_help)?1:0},{anchor:"100%",html:"",bodyCssClass:"",id:t.videoId+"-preview"},{xtype:"hidden",id:t.videoId+"-info",name:t.name}]},getCmp:function(e){return Ext.getCmp(this.videoId+"-"+e)},updatePreview:function(e){this.getCmp("preview").update(PageBlocks.utils.renderVideo(e.embed_video,e.title,e.provider))},updateInfo:function(e){var i=this.getCmp("info");Ext.isEmpty(e)?i.setValue(""):(i=i.getValue(),i=Ext.isEmpty(i)?{}:JSON.parse(i),e=Object.assign(i,e),this.getCmp("info").setValue(JSON.stringify(e)))},getInfo:function(e,i){Ext.isEmpty(e)||MODx.Ajax.request({url:PageBlocks.config.connectorUrl,params:{action:"web/video/parse",value:e,data:JSON.stringify(urlParser.parse(e))},listeners:{success:{fn:function(e){"function"==typeof i&&i.call(this,e.object)},scope:this},failure:{fn:function(e){MODx.msg.alert(_("error"),e.message)},scope:this}}})},infoWindow:function(){var e=this.getCmp("info").getValue(),e=Ext.isEmpty(e)?"":JSON.parse(e),i=MODx.load({xtype:"pb-video-info",record:e,videoId:this.videoId,source:this.config.source,source_path:this.config.source_path});i.reset(),Ext.isEmpty(e)||i.setValues(e),i.show()},loadFileForm:function(){this.fileform=new PageBlocks.fileformVideo({id:this.videoId+"-fileform",renderTo:Ext.getBody(),videoId:this.videoId,source:this.source,source_path:this.source_path,pbVideo:this})}}),Ext.reg("pb-panel-video",PageBlocks.panel.SuperVideoInfo),PageBlocks.window.SuperVideoInfoWindow=function(e){(e=e||{}).id||(e.id=Ext.id()),Ext.applyIf(e,{title:"Info",width:700}),PageBlocks.window.SuperVideoInfoWindow.superclass.constructor.call(this,e)},Ext.extend(PageBlocks.window.SuperVideoInfoWindow,PageBlocks.window.Default,{getFields:function(e){return[{layout:"column",items:[{columnWidth:.5,layout:"form",defaults:{msgTarget:"under"},items:[{xtype:"numberfield",inputType:"number",minValue:0,cls:"x-form-text",fieldLabel:_("pb_img_width"),name:"width",id:e.id+"-width",anchor:"100%",allowBlank:!0}]},{columnWidth:.5,layout:"form",defaults:{msgTarget:"under"},items:[{xtype:"numberfield",inputType:"number",minValue:0,cls:"x-form-text",fieldLabel:_("pb_img_height"),name:"height",id:e.id+"-height",anchor:"100%",allowBlank:!0}]}]},{xtype:"textfield",fieldLabel:_("pb_video_title"),description:"<b>[[+title]]</b>",name:"title",id:e.id+"-title",anchor:"100%",allowBlank:!0},{xtype:"textarea",fieldLabel:_("pb_video_description"),description:"<b>[[+description]]</b>",name:"description",id:e.id+"-description",anchor:"100%",allowBlank:!0,listeners:{render:function(e){PageBlocks.utils.renderRTE(e)}}},{xtype:"pb-image",fieldLabel:_("pb_video_preview"),description:"<b>[[+preview]]</b>",name:"preview",anchor:"100%",allowBlank:!0,source:e.source,source_path:"/"}]},submit:function(){var e=this.fp.getForm();e.isValid()&&(e=Object.assign(this.record,e.getValues()),Ext.getCmp(this.videoId+"-info").setValue(JSON.stringify(e)),this.close(),this.doLayout())}}),Ext.reg("pb-video-info",PageBlocks.window.SuperVideoInfoWindow),PageBlocks.fileformVideo=function(e){e=e||{},Ext.applyIf(e,{isUpload:!0,hidden:!0,fileUpload:!0,url:PageBlocks.config.connectorUrl,baseParams:{action:"web/browser/file/upload",source:e.source,source_path:e.source_path,idFile:e.videoId+"-file"},items:[{xtype:"fileuploadfield",id:e.videoId+"-file",source:e.source||MODx.config.default_media_source,allowedFileTypes:"mp4",listeners:{fileselected:(e,i)=>{this.onFileSelected(e,i)}}}]}),PageBlocks.fileformVideo.superclass.constructor.call(this,e)},Ext.extend(PageBlocks.fileformVideo,Ext.FormPanel,{onFileSelected:function(e,i){this.form.baseParams.file=i,this.form.submit({waitMsg:"Uploading...",params:{},success:function(e,i){var t={provider:"video",url:i.result.object.url,embed_video:i.result.object.url};this.pbVideo.getCmp("input").setValue(i.result.object.url),this.pbVideo.getCmp("info").setValue(JSON.stringify(t)),this.pbVideo.updatePreview(t)},failure:function(e,i){MODx.msg.alert("Error",i.result.message)},scope:this})}}),Ext.reg("pageblocks-fileform-video",PageBlocks.fileformVideo);