PageBlocks.grid.Table=function(e){(e=e||{}).id||(e.id="pb-table"),Ext.applyIf(e,{baseParams:{action:"web/table/getlist",model_type:e.model_type||PageBlocks.resource.class_key,model_id:e.model_id||0,context_key:PageBlocks.resource.context_key||MODx.config.default_context,field_id:e.field_id||0,collection_id:e.collection_id||0,deleted:0,data_type:"database",values:e.record?Ext.util.JSON.encode(e.record["_"+e.name]):"",sort:"menuindex",dir:"asc"},cls:"",ddAction:"web/table/sort",multi_select:!0}),PageBlocks.grid.Table.superclass.constructor.call(this,e)},Ext.extend(PageBlocks.grid.Table,PageBlocks.grid.Default,{getFields:function(e){let t=["id","alias","name","published","actions"];return e.table_columns&&e.table_columns.forEach(e=>{t.push(e.name)}),t},getColumns:function(t){let o=[{header:_("pb_grid_id"),dataIndex:"id",sortable:!1,width:75,fixed:!0}];return t.table_columns&&t.table_columns.forEach(e=>{o.push({header:e.caption,dataIndex:e.name,id:t.id+"-"+e.name,renderer:e.render?PageBlocks.utils[e.render]:"",sortable:!1,width:+e.width?e.width:"auto",fixed:!!+e.width})}),"2"===PageBlocks.config.modxversion&&o.push({header:_("pb_grid_actions"),dataIndex:"actions",renderer:PageBlocks.utils.renderActions,sortable:!1,width:200,fixed:!0,id:"actions"}),o},createObject:function(e,t){let o=this,i=this.config;PageBlocks.utils.request({action:"mgr/field/getlist",model_type:"pbTable",model_id:i.constructor_id,published:1,sort:"menuindex",dir:"asc"},e=>{e=MODx.load({xtype:"pb-table-window-create",record:{},table_fields:e.results,id:Ext.id(),listeners:{success:function(){o.refresh()}}});e.reset(),e.setValues({model_type:i.model_type||PageBlocks.resource.class_key,model_id:i.model_id,constructor_id:i.constructor_id,context_key:PageBlocks.resource.context_key||MODx.config.default_context,field_id:i.field_id||0,collection_id:i.collection_id||0,published:1}),e.show(t.target)})},updateObject:function(e,o,t){if(void 0!==t)this.menu.record=t.data;else if(!this.menu.record)return!1;PageBlocks.utils.request({action:"web/table/get",id:this.menu.record.id},e=>{var t=MODx.load({xtype:"pb-table-window-update",id:Ext.id(),record:e.object,table_fields:e.object.table_fields,listeners:{success:{fn:function(){this.refresh()},scope:this}}});t.reset(),t.setValues(e.object),t.show(o.target)})},copyTablesResource:function(){var e=MODx.load({xtype:"pb-copy-tables-resource",id:Ext.id(),listeners:{success:{fn:function(){this.refresh()},scope:this}}});e.reset(),e.setValues({method_path:"table/copy",model_id:PageBlocks.resource.id,context_key:PageBlocks.resource.context_key}),e.show()},import:function(e,t){var e=e.config,o=e.baseParams,i=MODx.load({xtype:"pb-import",id:Ext.id(),listeners:{success:{fn:function(){this.refresh()},scope:this}}});i.reset(),i.setValues({model_type:e.model_type,model_id:e.model_id,constructor_id:e.constructor_id,context_key:PageBlocks.resource.context_key,field_id:o.field_id,collection_id:e.collection_id}),i.show(t.target)},export:function(e,t){e.config;PageBlocks.utils.request({action:"web/table/getlist",model_type:this.config.model_type,model_id:this.config.model_id,context_key:PageBlocks.resource.context_key||MODx.config.default_context,field_id:this.config.field_id||0,collection_id:this.config.collection_id||0,deleted:0,sort:"menuindex",dir:"asc"},e=>{let i=[];e.results.forEach(e=>{var t=JSON.parse(e.values);t.published=e.published,delete t.id,delete t.createdon,delete t.editedon;for(const o in t)Ext.isEmpty(t[o])&&delete t[o];i.push(t)});e=MODx.load({xtype:"pb-export",id:Ext.id()});e.reset(),e.setValues({content:JSON.stringify(i)}),e.show(t.target)})},getTopBar:function(e){var t=[];return e.record&&"local"===e.record.data_type?[]:(PageBlocks.grid.create&&t.push({text:'<i class="icon icon-plus"></i>&nbsp;'+_("pb_row_create"),handler:this.createObject,scope:this}),t)}}),Ext.reg("pb-table",PageBlocks.grid.Table);